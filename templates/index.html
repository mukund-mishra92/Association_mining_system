<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Association Rule Mining Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .rule-card {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
        }
        .score-badge {
            font-size: 0.9em;
            padding: 4px 8px;
        }
        .progress-container {
            display: none;
            margin-top: 15px;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-chart-network me-2"></i>
                    Association Rule Mining Dashboard
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="checkConnections()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Check Status
                </button>
            </div>
        </nav>

        <!-- Status Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-server me-2"></i>
                            API Server Status
                        </h6>
                        <div id="server-status">
                            <span class="status-indicator status-disconnected"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-database me-2"></i>
                            Database Status
                        </h6>
                        <div id="database-status">
                            <span class="status-indicator status-disconnected"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Mining Panel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-pickaxe me-2"></i>Association Rule Mining</h5>
                    </div>
                    <div class="card-body">
                        <!-- Mining Method Selection -->
                        <div class="mb-3">
                            <label class="form-label">Mining Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="miningMethod" id="directMining" value="direct" checked>
                                <label class="form-check-label" for="directMining">
                                    <strong>Direct Mining</strong> <span class="badge bg-success">Recommended</span>
                                    <small class="d-block text-muted">Uses optimized algorithm for reliable results</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="miningMethod" id="apiMining" value="api">
                                <label class="form-check-label" for="apiMining">
                                    <strong>API-based Mining</strong>
                                    <small class="d-block text-muted">Enhanced temporal mining with progress tracking</small>
                                </label>
                            </div>
                        </div>

                        <!-- Mining Parameters -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="daysBack" class="form-label">Days Back</label>
                                <input type="number" class="form-control" id="daysBack" value="60" min="1" max="365">
                            </div>
                            <div class="col-md-6">
                                <label for="topSkus" class="form-label">Top SKUs</label>
                                <input type="number" class="form-control" id="topSkus" value="20" min="5" max="100">
                            </div>
                        </div>

                        <!-- API-specific options -->
                        <div id="apiOptions" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="useEnhanced">
                                <label class="form-check-label" for="useEnhanced">
                                    Use Enhanced Temporal Mining
                                </label>
                            </div>
                            <div id="methodSection" style="display: none;">
                                <label for="timeMethod" class="form-label">Time Weighting Method</label>
                                <select class="form-select mb-3" id="timeMethod">
                                    <option value="exponential_decay">Exponential Decay</option>
                                    <option value="seasonal_patterns">Seasonal Patterns</option>
                                    <option value="trend_adaptive">Trend Adaptive</option>
                                    <option value="recency_frequency">Recency Frequency</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" onclick="startMining()" id="startMiningBtn">
                                <i class="fas fa-play me-2"></i>
                                Start Mining
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="cancelMining()" id="cancelMiningBtn" style="display: none;">
                                <i class="fas fa-stop me-2"></i>
                                Cancel Mining
                            </button>
                        </div>

                        <!-- Progress Bar for API Mining -->
                        <div id="progress-container" class="progress-container">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Mining Progress</span>
                                <span class="text-muted" id="progress-percentage">0%</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     id="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted" id="progress-message">Initializing...</small>
                            </div>
                        </div>

                        <!-- Mining Status -->
                        <div id="mining-status" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-bar me-2"></i>Mining Results</h5>
                        <button class="btn btn-outline-success btn-sm" onclick="exportCSV()" id="exportBtn" disabled>
                            <i class="fas fa-download me-1"></i>
                            Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="mining-results">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <p>No mining results yet.<br>Start a mining operation to see results here.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightbulb me-2"></i>Item Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="itemSearch" 
                                           placeholder="Enter item name to get recommendations...">
                                    <button class="btn btn-outline-primary" onclick="getRecommendations()">
                                        <i class="fas fa-search me-1"></i>
                                        Get Recommendations
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="recommendations-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Logs Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-terminal me-2"></i>Live Mining Logs</h5>
                        <div>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                                <i class="fas fa-play me-1"></i>
                                Auto Refresh
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshLogs()">
                                <i class="fas fa-sync me-1"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="live-logs" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-terminal fa-2x mb-2"></i>
                                <p>Live logs will appear here during mining operations.</p>
                                <small>Click "Auto Refresh" to start monitoring logs in real-time.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRules = [];
        let progressInterval = null;
        let currentTaskId = null;

        // Check connections on page load
        window.onload = function() {
            checkConnections();
            
            // Toggle API options based on mining method
            document.querySelectorAll('input[name="miningMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('apiOptions').style.display = 
                        this.value === 'api' ? 'block' : 'none';
                });
            });
        };

        function checkConnections() {
            document.getElementById('server-status').innerHTML = 
                '<span class="status-indicator status-disconnected"></span><span>Checking...</span>';
            document.getElementById('database-status').innerHTML = 
                '<span class="status-indicator status-disconnected"></span><span>Checking...</span>';

            fetch('/api/test-connection')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Server status
                        const serverStatus = data.server.connected 
                            ? '<span class="status-indicator status-connected"></span><span>Connected</span>'
                            : '<span class="status-indicator status-disconnected"></span><span>Disconnected</span>';
                        document.getElementById('server-status').innerHTML = serverStatus;

                        // Database status
                        const dbStatus = data.database.connected 
                            ? '<span class="status-indicator status-connected"></span><span>Connected</span>'
                            : '<span class="status-indicator status-disconnected"></span><span>Error: ' + (data.database.error || 'Unknown') + '</span>';
                        document.getElementById('database-status').innerHTML = dbStatus;
                    } else {
                        document.getElementById('server-status').innerHTML = 
                            '<span class="status-indicator status-disconnected"></span><span>Error: ' + data.error + '</span>';
                        document.getElementById('database-status').innerHTML = 
                            '<span class="status-indicator status-disconnected"></span><span>Cannot check</span>';
                    }
                })
                .catch(error => {
                    document.getElementById('server-status').innerHTML = 
                        '<span class="status-indicator status-disconnected"></span><span>Connection failed</span>';
                    document.getElementById('database-status').innerHTML = 
                        '<span class="status-indicator status-disconnected"></span><span>Connection failed</span>';
                });
        }

        function startMining() {
            const miningMethod = document.querySelector('input[name="miningMethod"]:checked').value;
            const daysBack = parseInt(document.getElementById('daysBack').value);
            const topSkus = parseInt(document.getElementById('topSkus').value);
            
            // Show status
            const statusDiv = document.getElementById('mining-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Starting mining operation...</div>';

            if (miningMethod === 'direct') {
                // Direct mining
                fetch('/api/mine-direct', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        days_back: daysBack,
                        top_skus: topSkus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data.stats, data.rules);
                        statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Mining completed successfully!</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error + '</div>';
                });
            } else {
                // API mining with progress tracking
                const useEnhanced = document.getElementById('useEnhanced').checked;
                const timeMethod = document.getElementById('timeMethod').value;

                // Show progress bar
                showProgressBar();
                
                // Choose endpoint based on enhanced mining option
                const endpoint = useEnhanced ? '/api/mine-enhanced' : '/api/mine-api';
                const payload = {
                    days_back: daysBack,
                    top_skus: topSkus
                };
                
                // Add enhanced options if using enhanced mining
                if (!useEnhanced) {
                    payload.use_enhanced_mining = false;
                    payload.time_weighting_method = timeMethod;
                }
                
                fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentTaskId = data.task_id;
                        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-clock me-2"></i>' + 
                            (useEnhanced ? 'Enhanced Temporal Mining' : 'API Mining') + ' started! Tracking progress...</div>';
                        
                        // Start progress monitoring
                        startProgressMonitoring();
                    } else {
                        hideProgressBar();
                        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    hideProgressBar();
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error + '</div>';
                });
            }
        }

        function showProgressBar() {
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('startMiningBtn').style.display = 'none';
            document.getElementById('cancelMiningBtn').style.display = 'block';
        }

        function hideProgressBar() {
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('startMiningBtn').style.display = 'block';
            document.getElementById('cancelMiningBtn').style.display = 'none';
            
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function startProgressMonitoring() {
            progressInterval = setInterval(() => {
                fetch('/api/mining-progress')
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data.progress, data.message);
                        
                        if (data.status === 'completed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            hideProgressBar();
                            
                            // Debug: Log the complete data structure
                            console.log('Task completed. Full data structure:', data);
                            console.log('data.result exists:', !!data.result);
                            console.log('data.stats exists:', !!data.stats);
                            console.log('data.rules exists:', !!data.rules);
                            console.log('data.rules length:', data.rules ? data.rules.length : 'N/A');
                            
                            // Check if we have results (using the extracted stats and rules from Flask endpoint)
                            if (data.result && data.stats && data.rules && data.rules.length > 0) {
                                displayResults(data.stats, data.rules);
                                document.getElementById('mining-status').innerHTML = 
                                    '<div class="alert alert-success"><i class="fas fa-check me-2"></i>API mining completed successfully! Found ' + data.stats.total_rules + ' rules.</div>';
                            } else if (data.result && data.stats && (!data.rules || data.rules.length === 0)) {
                                document.getElementById('mining-status').innerHTML = 
                                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Mining completed but no association rules found. Try lowering the confidence threshold.</div>';
                            } else if (data.error) {
                                document.getElementById('mining-status').innerHTML = 
                                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Mining completed but results unavailable: ' + data.error + '</div>';
                            } else {
                                // Debug: Log the data structure to console
                                console.log('Mining completed but no results. Data structure:', data);
                                document.getElementById('mining-status').innerHTML = 
                                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Mining completed but no results returned. Check console for debug info.</div>';
                            }
                        } else if (data.status === 'failed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            hideProgressBar();
                            
                            const errorMsg = data.error || data.message || 'Unknown error occurred';
                            document.getElementById('mining-status').innerHTML = 
                                '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Mining failed: ' + errorMsg + '</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Progress monitoring error:', error);
                        document.getElementById('progress-message').textContent = 'Connection error: ' + error.message;
                    });
            }, 2000); // Check every 2 seconds
        }

        function updateProgress(percentage, message) {
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = percentage + '%';
            document.getElementById('progress-message').textContent = message;
        }

        function cancelMining() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            hideProgressBar();
            document.getElementById('mining-status').innerHTML = 
                '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Mining operation cancelled by user.</div>';
        }

        function displayResults(stats, rules) {
            const resultsDiv = document.getElementById('mining-results');
            currentRules = rules;
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0">${stats.total_rules}</div>
                            <small class="text-muted">Total Rules</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0">${stats.top_n_skus}</div>
                            <small class="text-muted">Top SKUs</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0">${stats.total_orders}</div>
                            <small class="text-muted">Orders</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0">${stats.score_range.max.toFixed(3)}</div>
                            <small class="text-muted">Max Score</small>
                        </div>
                    </div>
                </div>
                <div class="border-top pt-3">
                    <h6>Top Association Rules</h6>
            `;

            rules.slice(0, 10).forEach((rule, index) => {
                const scoreColor = rule.association_composite_score > 0.7 ? 'success' : 
                                 rule.association_composite_score > 0.5 ? 'warning' : 'secondary';
                
                html += `
                    <div class="rule-card p-2 border rounded mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <strong>${rule.sku1.substring(0, 25)}${rule.sku1.length > 25 ? '...' : ''}</strong>
                                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                <strong>${rule.sku2.substring(0, 25)}${rule.sku2.length > 25 ? '...' : ''}</strong>
                            </div>
                            <span class="badge bg-${scoreColor} score-badge">${rule.association_composite_score.toFixed(4)}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
            
            // Enable export button
            document.getElementById('exportBtn').disabled = false;
        }

        function getRecommendations() {
            const item = document.getElementById('itemSearch').value.trim();
            if (!item) {
                alert('Please enter an item name');
                return;
            }

            const resultsDiv = document.getElementById('recommendations-results');
            resultsDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Getting recommendations...</div>';

            fetch(`/api/recommendations/${encodeURIComponent(item)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.recommendations) {
                        const recommendations = data.data.recommendations;
                        if (recommendations.length > 0) {
                            let html = '<h6>Recommendations for: ' + data.data.main_item + '</h6><ul class="list-group list-group-flush">';
                            recommendations.forEach((rec, index) => {
                                html += '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                                    rec.recommended_item.substring(0, 30) +
                                    '<span class="badge bg-primary rounded-pill">' + rec.score.toFixed(4) + '</span></li>';
                            });
                            html += '</ul>';
                            resultsDiv.innerHTML = html;
                        } else {
                            resultsDiv.innerHTML = '<div class="alert alert-warning">No recommendations found for this item.</div>';
                        }
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">Error: ' + (data.error || 'Unknown error') + '</div>';
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error + '</div>';
                });
        }
        
        function exportCSV() {
            if (currentRules.length === 0) {
                alert('No rules to export');
                return;
            }
            
            fetch('/api/export-csv', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rules: currentRules})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = '/download/' + data.filename;
                    link.download = data.filename;
                    link.click();
                } else {
                    alert('Export failed: ' + data.error);
                }
            })
            .catch(error => {
                alert('Export error: ' + error);
            });
        }

        // Toggle method section based on enhanced mining checkbox
        document.getElementById('useEnhanced').addEventListener('change', function() {
            const methodSection = document.getElementById('methodSection');
            methodSection.style.display = this.checked ? 'block' : 'none';
        });

        // Live Logs Functionality
        let logRefreshInterval = null;
        let autoRefreshEnabled = false;

        function refreshLogs() {
            fetch('/api/logs/live')
                .then(response => response.json())
                .then(logs => {
                    const logsContainer = document.getElementById('live-logs');
                    
                    if (logs.length === 0) {
                        logsContainer.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-terminal fa-2x mb-2"></i>
                                <p>No recent logs found.</p>
                                <small>Logs will appear here when mining operations are running.</small>
                            </div>`;
                        return;
                    }

                    let logHtml = '';
                    logs.forEach(log => {
                        const levelClass = getLevelClass(log.level);
                        const levelIcon = getLevelIcon(log.level);
                        
                        logHtml += `
                            <div class="log-entry mb-2 p-2 border-start border-2 ${levelClass}" style="border-color: ${getLevelColor(log.level)} !important;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <small class="text-muted me-2">${log.timestamp}</small>
                                        <span class="badge ${levelClass} me-2">
                                            <i class="${levelIcon} me-1"></i>${log.level}
                                        </span>
                                        <small class="text-muted">${log.source || 'unknown'}</small>
                                    </div>
                                </div>
                                <div class="mt-1" style="white-space: pre-wrap; word-break: break-all;">
                                    ${escapeHtml(log.message)}
                                </div>
                            </div>`;
                    });

                    logsContainer.innerHTML = logHtml;
                    // Auto-scroll to bottom to show latest logs
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    const logsContainer = document.getElementById('live-logs');
                    logsContainer.innerHTML = `
                        <div class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Error loading logs: ${error.message}</p>
                        </div>`;
                });
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshEnabled) {
                // Stop auto refresh
                if (logRefreshInterval) {
                    clearInterval(logRefreshInterval);
                    logRefreshInterval = null;
                }
                autoRefreshEnabled = false;
                btn.innerHTML = '<i class="fas fa-play me-1"></i>Auto Refresh';
                btn.className = 'btn btn-outline-success btn-sm me-2';
            } else {
                // Start auto refresh
                autoRefreshEnabled = true;
                btn.innerHTML = '<i class="fas fa-pause me-1"></i>Stop Auto Refresh';
                btn.className = 'btn btn-outline-warning btn-sm me-2';
                
                // Refresh immediately
                refreshLogs();
                
                // Set up interval for every 2 seconds
                logRefreshInterval = setInterval(refreshLogs, 2000);
            }
        }

        function getLevelClass(level) {
            switch(level) {
                case 'ERROR': return 'bg-danger text-white';
                case 'WARNING': return 'bg-warning text-dark';
                case 'INFO': return 'bg-info text-white';
                case 'DEBUG': return 'bg-secondary text-white';
                default: return 'bg-light text-dark';
            }
        }

        function getLevelIcon(level) {
            switch(level) {
                case 'ERROR': return 'fas fa-times-circle';
                case 'WARNING': return 'fas fa-exclamation-triangle';
                case 'INFO': return 'fas fa-info-circle';
                case 'DEBUG': return 'fas fa-bug';
                default: return 'fas fa-circle';
            }
        }

        function getLevelColor(level) {
            switch(level) {
                case 'ERROR': return '#dc3545';
                case 'WARNING': return '#ffc107';
                case 'INFO': return '#0dcaf0';
                case 'DEBUG': return '#6c757d';
                default: return '#dee2e6';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start auto-refresh when mining operations begin
        function startMiningWithLogs() {
            // Enable auto-refresh for logs when mining starts
            if (!autoRefreshEnabled) {
                toggleAutoRefresh();
            }
        }

        // Modify the original startMining function to include log monitoring
        const originalStartMining = startMining;
        startMining = function() {
            originalStartMining();
            startMiningWithLogs();
        };
    </script>
</body>
</html>