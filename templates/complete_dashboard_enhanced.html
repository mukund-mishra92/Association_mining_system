<!DOCTYPE html>
<html>
<head>
    <title>Association Mining System - Enhanced Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header-banner {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .db-config-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #007bff;
            margin-bottom: 30px;
        }
        .mining-section {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #28a745;
            margin-bottom: 30px;
        }
        .results-section {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #ffc107;
            min-height: 400px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .rule-card {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .score-badge {
            font-size: 0.9em;
            padding: 4px 8px;
        }
        .progress-container {
            display: none;
            margin-top: 15px;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        .api-options-card {
            background: #e3f2fd;
            border: 2px solid #1976d2;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="header-banner">
            <i class="fas fa-chart-network me-3"></i>
            Association Mining System - Enhanced Dashboard
            <br><small>Configure Database → Run Mining → View Results</small>
        </div>
        
        <!-- Database Configuration Section -->
        <div class="db-config-section">
            <h2 class="mb-4">
                <i class="fas fa-database me-2"></i> Step 1: Database Configuration
            </h2>
            
            <form id="dbConfigForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Database Host</label>
                            <input type="text" class="form-control" id="dbHost" value="localhost" placeholder="localhost">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Database Name</label>
                            <input type="text" class="form-control" id="dbName" value="neo" placeholder="neo">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="dbUser" value="root" placeholder="root">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="dbPassword" value="root" placeholder="Enter password">
                        </div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">Table Names</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Order Table</label>
                            <input type="text" class="form-control" id="orderTable" value="wms_to_wcs_order_line_request_data">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">SKU Master Table</label>
                            <input type="text" class="form-control" id="skuTable" value="sku_master">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Recommendations Table</label>
                            <input type="text" class="form-control" id="recTable" value="sku_recommendations">
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-primary btn-lg" onclick="testConnection()">
                        <i class="fas fa-plug me-1"></i> Test Connection
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveConfig()">
                        <i class="fas fa-save me-1"></i> Save Configuration
                    </button>
                </div>
                
                <div id="dbResult" class="mt-3"></div>
            </form>
        </div>

        <!-- Mining Section -->
        <div class="mining-section">
            <h2 class="mb-4">
                <i class="fas fa-pickaxe me-2"></i> Step 2: Run Association Mining
            </h2>
            
            <!-- Mining Method Selection -->
            <div class="mb-4">
                <label class="form-label fw-bold">Mining Method</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="miningMethod" id="directMining" value="direct" checked>
                    <label class="form-check-label" for="directMining">
                        <strong>Direct Mining</strong> <span class="badge bg-success">Recommended</span>
                        <small class="d-block text-muted">Uses optimized algorithm for reliable results</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="miningMethod" id="apiMining" value="api">
                    <label class="form-check-label" for="apiMining">
                        <strong>API-based Mining</strong>
                        <small class="d-block text-muted">Enhanced temporal mining with progress tracking</small>
                    </label>
                </div>
            </div>

            <!-- Mining Parameters -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Days Back</label>
                        <input type="number" class="form-control" id="daysBack" value="60" min="1" max="365">
                        <small class="text-muted">How many days of data to analyze</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Top SKUs</label>
                        <input type="number" class="form-control" id="topSkus" value="20" min="5" max="100">
                        <small class="text-muted">Number of top SKUs to analyze</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div id="miningStatus" class="form-control-plaintext">
                            <span class="status-indicator status-disconnected"></span>
                            <span>Ready to start mining</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API-specific Enhanced Options -->
            <div id="apiOptions" style="display: none;">
                <div class="card api-options-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Enhanced Mining Options</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useEnhanced">
                            <label class="form-check-label fw-bold" for="useEnhanced">
                                Use Enhanced Temporal Mining
                                <small class="d-block text-muted">Advanced algorithms that consider time patterns and seasonality</small>
                            </label>
                        </div>
                        <div id="methodSection" style="display: none;">
                            <label for="timeMethod" class="form-label">Time Weighting Method</label>
                            <select class="form-select mb-3" id="timeMethod">
                                <option value="exponential_decay">Exponential Decay - Recent orders weighted more</option>
                                <option value="seasonal_patterns">Seasonal Patterns - Account for seasonal trends</option>
                                <option value="trend_adaptive">Trend Adaptive - Adapt to changing patterns</option>
                                <option value="recency_frequency">Recency Frequency - Balance recent vs frequent</option>
                            </select>
                            <small class="text-muted">Choose how to weight historical data for better predictions</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-md-flex">
                <button type="button" class="btn btn-success btn-lg" onclick="startMining()" id="miningBtn">
                    <i class="fas fa-play me-2"></i> Start Mining
                </button>
                <button type="button" class="btn btn-warning" onclick="cancelMining()" id="cancelBtn" style="display: none;">
                    <i class="fas fa-stop me-2"></i> Cancel Mining
                </button>
            </div>
            
            <!-- Progress Bar for API Mining -->
            <div id="miningProgress" class="progress-container">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Mining Progress</span>
                    <span class="text-muted" id="progressPercentage">0%</span>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="progressMessage">Initializing...</small>
                </div>
            </div>

            <div id="miningLog" class="mt-3"></div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i> Step 3: Mining Results
                </h2>
                <div>
                    <button class="btn btn-outline-success btn-sm me-2" onclick="exportResults()" id="exportBtn" style="display: none;">
                        <i class="fas fa-download me-1"></i> Export CSV
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshResults()" id="refreshBtn" style="display: none;">
                        <i class="fas fa-sync me-1"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Results Statistics -->
            <div id="resultsStats" style="display: none;">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary" id="totalRules">0</h5>
                                <p class="card-text text-muted">Total Rules</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success" id="totalSkus">0</h5>
                                <p class="card-text text-muted">SKUs Analyzed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h5 class="card-title text-info" id="totalOrders">0</h5>
                                <p class="card-text text-muted">Orders Processed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning" id="miningDuration">0s</h5>
                                <p class="card-text text-muted">Processing Time</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter and Sort Controls -->
            <div id="filterControls" style="display: none;">
                <div class="card border-light mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter & Sort Results</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Minimum Support</label>
                                <input type="number" class="form-control" id="minSupport" step="0.01" min="0" max="1" value="0.01" onchange="filterResults()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Minimum Confidence</label>
                                <input type="number" class="form-control" id="minConfidence" step="0.01" min="0" max="1" value="0.1" onchange="filterResults()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Sort By</label>
                                <select class="form-select" id="sortBy" onchange="sortResults()">
                                    <option value="score">Score (Descending)</option>
                                    <option value="support">Support (Descending)</option>
                                    <option value="confidence">Confidence (Descending)</option>
                                    <option value="lift">Lift (Descending)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Show Top</label>
                                <select class="form-select" id="showTop" onchange="limitResults()">
                                    <option value="10">Top 10</option>
                                    <option value="20">Top 20</option>
                                    <option value="50">Top 50</option>
                                    <option value="100">Top 100</option>
                                    <option value="-1">All Results</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="resultsContainer">
                <div class="text-center text-muted">
                    <i class="fas fa-chart-line fa-4x mb-3"></i>
                    <h4>No mining results yet</h4>
                    <p>Configure your database and start mining to see results here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentResults = [];
        let allRules = [];
        let progressInterval = null;
        let currentTaskId = null;
        
        // Initialize page
        window.onload = function() {
            loadDatabaseConfig();
            setupEventListeners();
        };
        
        function setupEventListeners() {
            // Mining method radio buttons
            document.querySelectorAll('input[name="miningMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const apiOptions = document.getElementById('apiOptions');
                    apiOptions.style.display = this.value === 'api' ? 'block' : 'none';
                });
            });
            
            // Enhanced mining checkbox
            document.getElementById('useEnhanced').addEventListener('change', function() {
                const methodSection = document.getElementById('methodSection');
                methodSection.style.display = this.checked ? 'block' : 'none';
            });
        }
        
        function loadDatabaseConfig() {
            fetch('/api/db-config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.config;
                        document.getElementById('dbHost').value = config.host || 'localhost';
                        document.getElementById('dbUser').value = config.user || 'root';
                        document.getElementById('dbPassword').value = config.password || '';
                        document.getElementById('dbName').value = config.database || 'neo';
                        document.getElementById('orderTable').value = config.order_table || 'wms_to_wcs_order_line_request_data';
                        document.getElementById('skuTable').value = config.sku_master_table || 'sku_master';
                        document.getElementById('recTable').value = config.recommendations_table || 'sku_recommendations';
                    }
                })
                .catch(error => console.error('Error loading database config:', error));
        }
        
        function testConnection() {
            const config = getDbConfig();
            document.getElementById('dbResult').innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Testing connection...</div>';
            
            fetch('/api/test-db-connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let tableInfo = '';
                    if (data.tables) {
                        tableInfo = '<br><strong>Table Status:</strong><ul class="mb-0">';
                        for (const [tableName, status] of Object.entries(data.tables)) {
                            const statusIcon = status.exists ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                            const displayName = tableName.replace('_table', '').replace('_', ' ');
                            tableInfo += `<li>${statusIcon} ${displayName}: ${status.exists ? `${status.count} records` : 'Not found'}</li>`;
                        }
                        tableInfo += '</ul>';
                    }
                    document.getElementById('dbResult').innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check me-2"></i>Connection Successful!</h5>
                            <strong>MySQL Version:</strong> ${data.mysql_version}
                            ${tableInfo}
                        </div>`;
                } else {
                    document.getElementById('dbResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Connection Failed!</h5>
                            ${data.error}
                        </div>`;
                }
            })
            .catch(error => {
                document.getElementById('dbResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Error!</h5>
                        ${error}
                    </div>`;
            });
        }
        
        function saveConfig() {
            const config = getDbConfig();
            
            fetch('/api/db-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('dbResult').innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check me-2"></i>Configuration Saved!</h5>
                            You can now proceed with mining operations.
                        </div>`;
                } else {
                    document.getElementById('dbResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Save Failed!</h5>
                            ${data.error}
                        </div>`;
                }
            });
        }
        
        function getDbConfig() {
            return {
                host: document.getElementById('dbHost').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value,
                database: document.getElementById('dbName').value,
                order_table: document.getElementById('orderTable').value,
                sku_master_table: document.getElementById('skuTable').value,
                recommendations_table: document.getElementById('recTable').value
            };
        }
        
        function startMining() {
            const miningMethod = document.querySelector('input[name="miningMethod"]:checked').value;
            const daysBack = parseInt(document.getElementById('daysBack').value);
            const topSkus = parseInt(document.getElementById('topSkus').value);
            
            // Update UI
            document.getElementById('miningBtn').disabled = true;
            document.getElementById('miningBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Mining in Progress...';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            // Update status
            updateMiningStatus('info', 'Starting mining operation...');
            
            if (miningMethod === 'direct') {
                startDirectMining(daysBack, topSkus);
            } else {
                startApiMining(daysBack, topSkus);
            }
        }
        
        function startDirectMining(daysBack, topSkus) {
            const params = {
                days_back: daysBack,
                top_n_skus: topSkus
            };
            
            fetch('/api/mine-direct', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                resetMiningUI();
                
                if (data.success && data.stats) {
                    updateMiningStatus('success', `Direct mining completed! Found ${data.stats.total_rules} rules in ${data.stats.mining_duration}`);
                    displayResults(data.stats, data.rules || []);
                } else {
                    updateMiningStatus('danger', `Mining failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                resetMiningUI();
                updateMiningStatus('danger', `Mining error: ${error}`);
            });
        }
        
        function startApiMining(daysBack, topSkus) {
            const useEnhanced = document.getElementById('useEnhanced').checked;
            const endpoint = useEnhanced ? '/api/mine-enhanced' : '/api/mine';
            
            const params = {
                days_back: daysBack,
                top_n_skus: topSkus
            };
            
            if (useEnhanced) {
                params.time_weighting_method = document.getElementById('timeMethod').value;
            }
            
            // Show progress bar
            showProgressBar();
            
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTaskId = data.task_id;
                    updateMiningStatus('info', useEnhanced ? 'Enhanced temporal mining started!' : 'API mining started!');
                    startProgressMonitoring();
                } else {
                    hideProgressBar();
                    resetMiningUI();
                    updateMiningStatus('danger', `Error: ${data.error}`);
                }
            })
            .catch(error => {
                hideProgressBar();
                resetMiningUI();
                updateMiningStatus('danger', `Error: ${error}`);
            });
        }
        
        function showProgressBar() {
            document.getElementById('miningProgress').style.display = 'block';
        }
        
        function hideProgressBar() {
            document.getElementById('miningProgress').style.display = 'none';
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        function startProgressMonitoring() {
            progressInterval = setInterval(() => {
                fetch('/api/mining-progress')
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data.progress, data.message);
                        
                        if (data.status === 'completed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            hideProgressBar();
                            resetMiningUI();
                            
                            if (data.result && data.stats && data.rules && data.rules.length > 0) {
                                displayResults(data.stats, data.rules);
                                updateMiningStatus('success', `Mining completed! Found ${data.stats.total_rules} rules.`);
                            } else {
                                updateMiningStatus('warning', 'Mining completed but no association rules found.');
                            }
                        } else if (data.status === 'failed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            hideProgressBar();
                            resetMiningUI();
                            updateMiningStatus('danger', `Mining failed: ${data.error || data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Progress monitoring error:', error);
                        document.getElementById('progressMessage').textContent = 'Connection error: ' + error.message;
                    });
            }, 2000);
        }
        
        function updateProgress(percentage, message) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressMessage').textContent = message;
        }
        
        function cancelMining() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            hideProgressBar();
            resetMiningUI();
            updateMiningStatus('warning', 'Mining operation cancelled.');
        }
        
        function resetMiningUI() {
            document.getElementById('miningBtn').disabled = false;
            document.getElementById('miningBtn').innerHTML = '<i class="fas fa-play me-2"></i> Start Mining';
            document.getElementById('cancelBtn').style.display = 'none';
        }
        
        function updateMiningStatus(type, message) {
            const statusClass = type === 'success' ? 'alert-success' : 
                               type === 'warning' ? 'alert-warning' : 
                               type === 'info' ? 'alert-info' : 'alert-danger';
            const icon = type === 'success' ? 'fas fa-check' : 
                        type === 'warning' ? 'fas fa-exclamation-triangle' : 
                        type === 'info' ? 'fas fa-info-circle' : 'fas fa-exclamation-triangle';
            
            document.getElementById('miningLog').innerHTML = `
                <div class="alert ${statusClass}">
                    <i class="${icon} me-2"></i>${message}
                </div>`;
        }
        
        function displayResults(stats, rules) {
            allRules = rules || [];
            currentResults = [...allRules];
            
            // Show stats
            document.getElementById('resultsStats').style.display = 'block';
            document.getElementById('filterControls').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'inline-block';
            document.getElementById('refreshBtn').style.display = 'inline-block';
            
            // Update statistics cards
            document.getElementById('totalRules').textContent = stats.total_rules || 0;
            document.getElementById('totalSkus').textContent = stats.top_n_skus || 0;
            document.getElementById('totalOrders').textContent = stats.total_orders || 0;
            document.getElementById('miningDuration').textContent = stats.mining_duration || '0s';
            
            // Display rules
            renderResults();
        }
        
        function renderResults() {
            const container = document.getElementById('resultsContainer');
            
            if (currentResults.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h5>No results match your current filters</h5>
                        <p>Try adjusting the filter criteria above.</p>
                    </div>`;
                return;
            }
            
            let html = '';
            currentResults.forEach((rule, index) => {
                // Handle different rule formats
                const antecedents = rule.antecedents || rule.sku1 || 'Unknown';
                const consequents = rule.consequents || rule.sku2 || 'Unknown';
                const score = rule.score || rule.composite_score || 0;
                const support = rule.support || 0;
                const confidence = rule.confidence || 0;
                const lift = rule.lift || 0;
                
                html += `
                    <div class="rule-card card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <span class="badge bg-primary me-2">#${index + 1}</span>
                                        ${antecedents} → ${consequents}
                                    </h6>
                                    <p class="card-text text-muted small">
                                        If customers buy <strong>${antecedents}</strong>, 
                                        they are likely to also buy <strong>${consequents}</strong>
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-success score-badge me-1">
                                        Score: ${score.toFixed(3)}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        Support: ${support.toFixed(3)} | 
                                        Confidence: ${confidence.toFixed(3)} | 
                                        Lift: ${lift.toFixed(3)}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function filterResults() {
            const minSupport = parseFloat(document.getElementById('minSupport').value);
            const minConfidence = parseFloat(document.getElementById('minConfidence').value);
            
            currentResults = allRules.filter(rule => 
                (rule.support || 0) >= minSupport && 
                (rule.confidence || 0) >= minConfidence
            );
            
            sortResults();
        }
        
        function sortResults() {
            const sortBy = document.getElementById('sortBy').value;
            
            currentResults.sort((a, b) => {
                let valueA = a[sortBy] || a.composite_score || 0;
                let valueB = b[sortBy] || b.composite_score || 0;
                
                // Handle different property names
                if (sortBy === 'score') {
                    valueA = a.score || a.composite_score || 0;
                    valueB = b.score || b.composite_score || 0;
                }
                
                return valueB - valueA; // Descending order
            });
            
            limitResults();
        }
        
        function limitResults() {
            const showTop = parseInt(document.getElementById('showTop').value);
            
            if (showTop > 0 && currentResults.length > showTop) {
                currentResults = currentResults.slice(0, showTop);
            }
            
            renderResults();
        }
        
        function refreshResults() {
            if (allRules.length > 0) {
                currentResults = [...allRules];
                filterResults();
            }
        }
        
        function exportResults() {
            if (currentResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            fetch('/api/export-csv', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rules: currentResults})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const link = document.createElement('a');
                    link.href = '/download/' + data.filename;
                    link.download = data.filename;
                    link.click();
                } else {
                    alert('Export failed: ' + data.error);
                }
            })
            .catch(error => {
                alert('Export error: ' + error);
            });
        }
    </script>
</body>
</html>